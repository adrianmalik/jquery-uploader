var Uploader={};jQuery.fn.upload=function(e){var t=(new Uploader.Filter).filterParams(e);var n=new Uploader.Browser(t.browser);var r=new Uploader.Preview(t.preview);var i=new Uploader.Input(this[0],t);i.hide().attachOnChange(r);n.render();n.attachOnClick(i);n.attachOnDrop(r);n.attachOnDragEnter();n.attachOnDragOver();r.renderContainer()};Uploader.Filter=function(){var e=this;this.filterParams=function(t){if(typeof t.browser!=="object"){t.browser={}}if(typeof t.preview!=="object"){t.preview={}}t.browser=e.filterBrowserParams(t.browser);t.preview=e.filterPreviewParams(t.preview);return t};this.filterBrowserParams=function(e){if(typeof e.render!=="function"){e.render=function(){var e=document.createElement("button");$(e).text("Select file");return e}}if(typeof e.onDrop!=="function"){e.onDrop=function(e,t){}}if(typeof e.onClick!=="function"){e.onClick=function(e,t){}}if(typeof e.onDragOver!=="function"){e.onDragOver=function(e,t){}}if(typeof e.onDragEnter!=="function"){e.onDragEnter=function(e,t){}}return e};this.filterPreviewParams=function(e){if(typeof e.upload!=="object"){e.upload={}}if(typeof e.upload.onLoadStart!=="function"){e.upload.onLoadStart=function(e,t,n){}}if(typeof e.upload.onProgress!=="function"){e.upload.onProgress=function(e,t,n){}}if(typeof e.upload.onAbort!=="function"){e.upload.onAbort=function(e,t,n){}}if(typeof e.upload.onError!=="function"){e.upload.onError=function(e,t,n){}}if(typeof e.upload.onLoad!=="function"){e.upload.onLoad=function(e,t,n){}}if(typeof e.upload.onLoadEnd!=="function"){e.upload.onLoadEnd=function(e,t,n){}}if(typeof e.upload.onTimeout!=="function"){e.upload.onTimeout=function(e,t,n){}}if(typeof e.upload.url!=="string"){e.upload.url="/upload"}if(typeof e.crop!=="boolean"){e.crop=false}if(typeof e.maxFiles!=="number"){e.maxFiles=1}return e}};Uploader.Validator=function(){var e=function(e){var t="";var n="";for(index in e){if(isNaN(e[index])){t+=e[index]}else{n+=e[index]}}n=parseInt(n);if(t){switch(t.toUpperCase()){case"B":break;case"KB":n=n*1024;break;case"MB":n=n*1024*1024;break;case"GB":n=n*1024*1024*1024;break;case"TB":n=n*1024*1024*1024*1024;break;case"PB":n=n*1024*1024*1024*1024*1024;break}}return n};this.validateFileSize=function(t,n,r,i){var s=null;if(typeof n==="string"){var n=e(n);if(t.size>n){if(typeof i==="object"&&typeof i.tooLargeFile!=="string"&&i.tooLargeFile){s=i.tooLargeFile}else{s="Your file is too large."}}}if(typeof r==="string"){var r=e(r);if(t.size<r){if(typeof i==="object"&&typeof i.tooSmallFile!=="string"&&i.tooSmallFile){s=i.tooSmallFile}else{s="Your file is too small."}}}return s};this.validateFileMimeType=function(e,t,n){var r=null;var i=t.allowedMimeTypes;var s=t.forbiddenMimeTypes;if(typeof i==="object"&&i.length>0){if(i.indexOf(e.type)===-1){if(typeof n==="object"&&typeof n.forbidden!=="string"&&n.forbidden){r=n.forbidden}else{r="File is forbidden."}}}if(typeof s==="object"&&s.length>0){if(s.indexOf(e.type)!==-1){if(typeof n==="object"&&typeof n.forbidden!=="string"&&n.forbidden){r=n.forbidden}else{r="File is forbidden."}}}return r};this.validateFilesNumber=function(e,t,n){var r=null;if(typeof e==="number"){if(t>=e){if(typeof n==="object"&&typeof n.tooManyFiles!=="string"&&n.tooManyFiles){r=n.tooManyFiles}else{r="You cannot upload more files."}}}return r};this.validateFileExtension=function(e,t,n){var r=null;var i=t.allowedExtensions;var s=t.forbiddenExtensions;if(typeof i==="object"&&i.length>0){var o=e.name.split(".").pop();if(i.indexOf(o)===-1){if(typeof n==="object"&&typeof n.forbidden!=="string"&&n.forbidden){r=n.forbidden}else{r="File is forbidden."}}}if(typeof s==="object"&&s.length>0){var o=e.name.split(".").pop();if(s.indexOf(o)!==-1){if(typeof n==="object"&&typeof n.forbidden!=="string"&&n.forbidden){r=n.forbidden}else{r="File is forbidden."}}}return r};this.validateCropping=function(e,t){var n=null;var r=new Uploader.Html;if(t&&e!==r.TAG_IMG){n="You can only crop images."}return n}};Uploader.Request=function(e,t,n,r){var i=this;var s=new XMLHttpRequest;s.open("POST",r.url);s.onloadstart=function(n){r.onLoadStart(n,t,e)};s.onabort=function(n){r.onAbort(n,t,e)};s.onerror=function(n){r.onError(n,t,e)};s.onload=function(n){r.onLoad(n,t,e)};s.onloadend=function(n){r.onLoadEnd(n,t,e)};s.ontimeout=function(n){r.onTimeout(n,t,e)};s.onprogress=function(i){if(i.lengthComputable){var s=i.loaded/i.total*100;$(n).attr("value",s)}r.onProgress(i,t,e)};this.send=function(){var e=new FormData;e.append("files",t);s.send(e)};return s};Uploader.Input=function(e,t){var n=this;new function(){if($(e).prop("tagName").toLowerCase()!=="input"){throw new Error("Missing input file")}if($(e).attr("type")!=="file"){throw new Error('Input must have type "file"')}if(t.preview.maxFiles>1){$(e).attr("multiple","multiple")}};this.attachOnChange=function(t){$(e).on("change",function(e){var n=e.originalEvent.srcElement.files;for(var r=0;r<n.length;r++){t.renderItem(n[r])}});return n};this.hide=function(){$(e).hide();return n};this.getHtmlElement=function(){return e};return n};Uploader.Preview=function(e){var t=this;this.counter;this.htmlElements;this.crop=e.crop;this.error=e.error;this.render=e.render;this.styles=e.styles;this.upload=e.upload;this.maxFiles=e.maxFiles;this.minFileSize=e.minFileSize;this.maxFileSize=e.maxFileSize;this.errorMessages=e.errorMessages;this.allowedMimeTypes=e.allowedMimeTypes;this.allowedExtensions=e.allowedExtensions;this.forbiddenMimeTypes=e.forbiddenMimeTypes;this.forbiddenExtensions=e.forbiddenExtensions;this.renderContainer=function(){t.htmlElements=t.render();return t};this.renderItem=function(e){var n=t.validateFile(e);if(!n){if(typeof t.counter!=="number"){t.counter=1}else{t.counter++}t.handleItem(e)}else{if(typeof t.error==="function"){t.error(n)}}};this.validateFile=function(e){var n=new Uploader.Validator;var r=n.validateFileExtension(e,{allowedExtensions:t.allowedExtensions,forbiddenExtensions:t.forbiddenExtensions},t.errorMessages);if(!r){r=n.validateFileMimeType(e,{allowedMimeTypes:t.allowedMimeTypes,forbiddenMimeTypes:t.forbiddenMimeTypes},t.errorMessages)}if(!r){r=n.validateFileSize(e,t.maxFileSize,t.minFileSize,t.errorMessages)}if(!r){r=n.validateFilesNumber(t.maxFiles,t.counter,t.errorMessages)}if(!r){r=n.validateCropping(t.getHtmlThumbnailTagForFile(e),t.crop)}return r};this.handleItem=function(e){var n=null;var r=null;var i=null;var s=null;var o=$(t.htmlElements.item).clone();var u=t.generatePreview(e);$(t.htmlElements.container).append(o);for(var a in t.htmlElements){if(a!=="container"&&a!=="item"){switch(a){case"preview":s=$(t.htmlElements[a]).clone();$(o).append(s.append(u));break;case"upload":n=$(t.htmlElements[a]).clone();$(o).append(n);break;case"cancel":r=$(t.htmlElements[a]).clone();$(o).append(r);break;case"progress":i=$(t.htmlElements[a]).clone();$(o).append(i);break;default:$(o).append($(t.htmlElements[a]).clone())}}}t.attachUploadEvent(n,r,e,i,o)};this.generatePreview=function(e){var n;var r=t.styles;var i=new Uploader.Html;var s=new Uploader.Thumbnail;switch(t.getHtmlThumbnailTagForFile(e)){case i.TAG_IMG:n=s.getImage(e,r);break;case i.TAG_VIDEO:n=s.getVideo(e,r);break;default:n=s.getDefault(e,r);break}return n};this.getHtmlThumbnailTagForFile=function(e){var t=e.type;if(typeof t!=="string"){throw new Error("Invalid mime type for preview")}var n=(new Uploader.Html).TAG_DIV;if(t.indexOf("image")!=-1){n=(new Uploader.Html).TAG_IMG}if(t.indexOf("video")!=-1){n=(new Uploader.Html).TAG_VIDEO}return n};this.attachUploadEvent=function(e,n,r,i,s){var o;$(e).on("click",function(){o=(new Uploader.Request(e,r,i,t.upload)).send()});$(n).on("click",function(){if(typeof o!=="undefined"){o.abort()}$(s).remove();t.counter--})}};Uploader.Browser=function(e){var t=this;this.htmlElement;this.onDrop=e.onDrop;this.onClick=e.onClick;this.onDragOver=e.onDragOver;this.onDragEnter=e.onDragEnter;this.render=function(){t.htmlElement=e.render();return t};this.attachOnDrop=function(e){$(t.htmlElement).on("drop",function(n){n.preventDefault();for(var r=0;r<n.originalEvent.dataTransfer.files.length;r++){e.renderItem(files[r])}t.onDrop(this,n)});return t};this.attachOnDragEnter=function(){$(t.htmlElement).on("dragenter",function(e){e.stopPropagation();e.preventDefault();t.onDragEnter(this,e)});return t};this.attachOnDragOver=function(){$(t.htmlElement).on("dragover",function(e){e.stopPropagation();e.preventDefault();t.onDragOver(this,e)});return t};this.attachOnClick=function(e){$(t.htmlElement).on("click",function(n){n.preventDefault();$(e.getHtmlElement()).trigger("click");t.onClick(this,n)});return t}};Uploader.Html=function(){var e=this;this.TAG_UL="ul";this.TAG_LI="li";this.TAG_IMG="img";this.TAG_DIV="div";this.TAG_SPAN="span";this.TAG_VIDEO="video";this.TAG_BUTTON="button";this.TAG_PROGRESS="progress";this.TYPE_OBJECT="object";this.TYPE_STRING="string";this.TYPE_NUMBER="number";this.TYPE_UNDEFINED="undefined";this.getUl=function(){return document.createElement(e.TAG_UL)};this.getLi=function(){return document.createElement(e.TAG_LI)};this.getImg=function(){return document.createElement(e.TAG_IMG)};this.getDiv=function(){return document.createElement(e.TAG_DIV)};this.getSpan=function(){return document.createElement(e.TAG_SPAN)};this.getVideo=function(){return document.createElement(e.TAG_VIDEO)};this.getButton=function(){return document.createElement(e.TAG_BUTTON)};this.getProgress=function(){var t=document.createElement(e.TAG_PROGRESS);$(t).attr("value","0").attr("max","100");return t}};Uploader.Thumbnail=function(){var e=this;var t=function(t,n){if(typeof n==="object"){for(var r in n){$(t).css(r,n[r])}}return e};this.getImage=function(e,n){var r=(new Uploader.Html).getImg();var i=new FileReader;i.onloadend=function(){r.src=i.result;t(r,n)};i.readAsDataURL(e);return r};this.getVideo=function(e,n){var r=new(Uploader.Html().getVideo);var i=new FileReader;i.onloadend=function(){r.src=i.result;t(r,n)};i.readAsDataURL(e);return r};this.getDefault=function(e,t){return"//TODO"};this.filterParams=function(e){var t=new Uploader.Html;if(typeof e!==t.TYPE_OBJECT){e={}}if(typeof e.container!==t.TYPE_OBJECT){e.container=t.getUl();$("#preview").html(e.container)}if(typeof e.item!==t.TYPE_OBJECT){e.item=t.getLi()}if(typeof e.preview!==t.TYPE_OBJECT){e.preview=t.getDiv()}if(typeof e.progress!==t.TYPE_OBJECT){e.progress=t.getProgress()}if(typeof e.upload!==t.TYPE_OBJECT){e.upload=t.getButton();$(e.upload).text("Upload file")}if(typeof e.cancel!==t.TYPE_OBJECT){e.cancel=t.getButton();$(e.cancel).text("Cancel")}return e}}